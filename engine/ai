#!/usr/bin/env python3
"""
ai — CLI entrypoint for the Scaffold AI engine.

Usage:
    ai init                        Initialize .ai/ and .ai_runtime/ in the project
    ai run                         Start the interactive orchestrator loop
    ai help [--json]               Context-aware help and usage guide
    ai status                      Generate and print project status report
    ai export-memory [--out PATH]  Export memory pack
    ai import-memory --in PATH     Import memory pack
    ai rehydrate-db                Rebuild SQLite DB from canonical YAML
    ai validate                    Validate YAML against JSON schemas
    ai git-sync                    Commit canonical state files to git
    ai memory export [--out PATH]  Export session memory pack
    ai memory import --in PATH     Import session memory pack
    ai memory purge [--ns NS] [--days N]  Purge session memory

Submodule usage:
    python vendor/scaffold-ai/engine/ai init
    python vendor/scaffold-ai/engine/ai status
"""

import os
import sys

# Ensure the engine package is importable
engine_dir = os.path.dirname(os.path.abspath(__file__))
skeleton_dir = os.path.dirname(engine_dir)
if skeleton_dir not in sys.path:
    sys.path.insert(0, skeleton_dir)

from engine import ai_git, ai_init, ai_run


def print_help():
    print("""
Scaffold AI — CLI

Commands:
  init                        Initialize .ai/ and .ai_runtime/ in the project
  run                         Start the interactive orchestrator loop
  help [--json]               Context-aware help and usage guide
  status                      Generate and print project status report
  export-memory [--out PATH]  Export memory pack for portability
  import-memory --in PATH     Import a memory pack
  rehydrate-db                Rebuild SQLite DB from canonical YAML
  validate                    Validate YAML against JSON schemas
  git-sync                    Commit canonical state files to git
  migrate                     Apply new template files (non-destructive)
  memory export [--out PATH]  Export session memory pack (advanced)
  memory import --in PATH     Import session memory pack (advanced)
  memory purge [--ns NS]      Purge session memory (advanced)

Options:
  --help, -h                  Show this help message
  --non-interactive           Skip onboarding prompts during init

Examples (submodule usage):
  python vendor/scaffold-ai/engine/ai init
  python vendor/scaffold-ai/engine/ai status
  python vendor/scaffold-ai/engine/ai export-memory --out pack.zip
""")


def main():
    args = sys.argv[1:]

    if not args or args[0] in ("--help", "-h"):
        print_help()
        sys.exit(0)

    command = args[0]

    # Find project root
    try:
        project_root = ai_git.find_project_root()
    except FileNotFoundError as e:
        print(f"Error: {e}")
        sys.exit(1)

    # Parse flags
    flags = {}
    i = 1
    while i < len(args):
        if args[i].startswith("--"):
            key = args[i][2:].replace("-", "_")
            if i + 1 < len(args) and not args[i + 1].startswith("--"):
                flags[key] = args[i + 1]
                i += 2
            else:
                flags[key] = True
                i += 1
        else:
            i += 1

    if command == "init":
        interactive = "non_interactive" not in flags
        ai_init.init(project_root, interactive=interactive)

    elif command == "run":
        ai_run.run_loop(project_root)

    elif command in ("help", "guide"):
        result = ai_run.handle_help(project_root, json="json" in flags)
        print(result)

    elif command == "status":
        result = ai_run.handle_status(project_root, json="json" in flags)
        print(result)

    elif command == "export-memory":
        result = ai_run.handle_export_memory(project_root, out=flags.get("out"))
        print(result)

    elif command == "import-memory":
        in_path = flags.get("in", flags.get("in_"))
        if not in_path:
            print("Error: --in <path> is required.")
            sys.exit(1)
        result = ai_run.handle_import_memory(project_root, in_path=in_path)
        print(result)

    elif command == "rehydrate-db":
        result = ai_run.handle_rehydrate_db(project_root)
        print(result)

    elif command == "validate":
        result = ai_run.handle_validate(project_root)
        print(result)

    elif command == "git-sync":
        result = ai_run.handle_git_sync(project_root, message=flags.get("message"))
        print(result)

    elif command == "migrate":
        result = ai_run.handle_migrate(project_root)
        print(result)

    elif command == "memory":
        subcmd = args[1] if len(args) > 1 else ""
        if subcmd == "export":
            result = ai_run.handle_session_memory_export(
                project_root, out=flags.get("out"),
                namespaces=flags.get("ns"),
            )
            print(result)
        elif subcmd == "import":
            in_path = flags.get("in", flags.get("in_"))
            if not in_path:
                print("Error: --in <path> is required.")
                sys.exit(1)
            result = ai_run.handle_session_memory_import(project_root, in_path=in_path)
            print(result)
        elif subcmd == "purge":
            result = ai_run.handle_session_memory_purge(
                project_root,
                namespace=flags.get("ns"),
                days=flags.get("days"),
            )
            print(result)
        else:
            print(f"Unknown memory subcommand: '{subcmd}'")
            print("Available: memory export, memory import, memory purge")
            sys.exit(1)

    else:
        print(f"Unknown command: '{command}'")
        print_help()
        sys.exit(1)


if __name__ == "__main__":
    main()
